#include "utils.h"

void encrypt (char *buffer, size_t size, unsigned char key) {
    unsigned char k;
    
    for (int i = 0, k = key; i < size; k = buffer[i++]) {
        buffer[i] ^= k;
    }
}

void decrypt(char *buffer, size_t size, unsigned char key) {
    unsigned char k;

    for (int i = size - 1; i >= 0; i--) {
        buffer[i] ^= buffer[i-1];
    }

    buffer[0] ^= key;
}

char * encode_hex(char *input, size_t size) {
    char *output;
    char *ptr;

    size_t output_size = size * 2 + 1;

    if (!(output = malloc(output_size))) {
        perror("malloc");
        exit(1);
    }

    bzero(output, output_size);
    ptr = output;

    for (int i = 0; i < size; i++) {
        snprintf(ptr, 3, "%02hhx", input[i] & 0xff);
        ptr += 2;
    }

    return output;
}

char * decode_hex(char *input) {
    char *output;
    char buf[4] = {0};
    size_t size = strlen(input) / 2 + 1;

    if (!(output = malloc(size))) {
        perror("malloc");
        exit(1);
    }

    int i;
    for (i = 0; i < size; i++) {
        memcpy(buf, input + i * 2, 2);
        output[i] = strtol(buf, NULL, 16);
    }

    output[i] = '\0';

    return output;
}

unsigned char extract_key(char *session) {
    unsigned char key;
    unsigned short part;

    sscanf(session, "%04hx-%02hhx-%04hx", &part, &key, &part);

    return key;
}