#include "utils.h"

struct domain_list *create_list() {
    struct domain_list *list;

    if (!(list = malloc(sizeof (struct domain_list)))) {
        perror("malloc");
        exit(1);
    }

    bzero(list, sizeof(struct domain_list));

    list->prev = list;
    list->next = list;

    return list;
}

void insert_domain(struct domain_list *list, char *domain, size_t size) {
    struct domain_list *new_list;
    char *data;

    if (list == NULL) return;

    if (!(data = malloc(size + 1))) {
        perror("malloc");
        exit(1);
    }

    memcpy(data, domain, size);
    data[size] = '\0';

    if (list->data == NULL) {
        list->data = data;
        list->size = size;
    } else {
        new_list = create_list();
        new_list->data = data;
        new_list->size = size;

        if (list->prev == NULL && list->next == NULL) {
            new_list->next = list;
            new_list->prev = list;

            list->prev = new_list;
            list->next = new_list;
        } else {
            new_list->prev = list->prev;
            new_list->next = list;

            list->prev->next = new_list;
            list->prev = new_list;
        } 
    }
}

char * get_nth_part(struct domain_list *list, unsigned int n) {
    list = list->prev;

    for (int i = 0; i < n; list = list->prev, i++);

    return list->data;
}

char * encode_hex(char *input, size_t size) {
    char *output;
    char *ptr;

    size_t output_size = size * 2 + 1;

    if (!(output = malloc(output_size))) {
        perror("malloc");
        exit(1);
    }

    ptr = output;

    for (int i = 0; i < size; i++) {
        snprintf(ptr, 3, "%02hhx", input[i] & 0xff);
        ptr += 2;
    }

    return output;
}

char * decode_hex(char *input) {
    char *output;
    char buf[4] = {0};
    size_t size = strlen(input) / 2 + 1;

    if (!(output = malloc(size))) {
        perror("malloc");
        exit(1);
    }

    int i;
    for (i = 0; i < size; i++) {
        memcpy(buf, input + i * 2, 2);
        output[i] = strtol(buf, NULL, 16);
    }

    output[i] = '\0';

    return output;
}

unsigned char extract_key(char *session) {
    unsigned char key;
    unsigned short part;

    sscanf(session, "%04hx-%02hhx-%04hx", &part, &key, &part);

    return key;
}